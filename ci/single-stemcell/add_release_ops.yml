- type: replace
  path: /groups/-
  value:
    name: ((release_branch))
    jobs:
    - ((release_branch))-bats
    - ((release_branch))-build-vcloud-esxi
    - ((release_branch))-build-vsphere-esxi
    - ((release_branch))-build-openstack-kvm
    - ((release_branch))-build-google-kvm
    - ((release_branch))-build-azure-hyperv
    - ((release_branch))-build-aws-xen-hvm
    - ((release_branch))-build-warden-boshlite
    - ((release_branch))-test-stemcells
    - ((release_branch))-build-stemcell
    - ((release_branch))-test-unit
    - ((release_branch))-publish-stemcells
    - ((release_branch))-build-os-image
    - ((release_branch))-start-job

- type: replace
  path: /jobs/-
  value:
    name: ((release_branch))-start-job
    serial: true
    plan:
      - get: ((release_branch))-bosh-linux-stemcell-builder

- type: replace
  path: /jobs/-
  value:
    name: ((release_branch))-build-os-image
    plan:
      - get: ((release_branch))-bosh-linux-stemcell-builder
        trigger: true
        passed:
          - ((release_branch))-start-job
      - task: build
        file: ((release_branch))-bosh-linux-stemcell-builder/ci/os-images/tasks/build.yml
        privileged: true
        params:
          OPERATING_SYSTEM_NAME:      ((stemcell_os))
          OPERATING_SYSTEM_VERSION:   ((stemcell_os_version))
        input_mapping:
          bosh-linux-stemcell-builder: ((release_branch))-bosh-linux-stemcell-builder
      - put: ((release_branch))-os-image-tarball
        params:
          file: os-image/((stemcell_os))-((stemcell_os_version)).tgz
          acl: public-read

- type: replace
  path: /jobs/-
  value:
    name: ((release_branch))-test-unit
    serial: true
    plan:
      - get: ((release_branch))-bosh-linux-stemcell-builder
        trigger: true
      - task: test-unit
        file: ((release_branch))-bosh-linux-stemcell-builder/ci/tasks/test-unit.yml
        input_mapping:
          bosh-linux-stemcell-builder: ((release_branch))-bosh-linux-stemcell-builder

- type: replace
  path: /jobs/-
  value:
    name: ((release_branch))-build-stemcell
    serial: true
    plan:
      - get: ((release_branch))-bosh-linux-stemcell-builder
        trigger: true
        passed:
          - ((release_branch))-test-unit
      - get: ((release_branch))-version
        params:
          bump: major
      - put: ((release_branch))-version
        params:
          file: ((release_branch))-version/number

- type: replace
  path: /jobs/-
  value:
    name: ((release_branch))-test-stemcells
    serial: true
    plan:
      - do:
        - aggregate:
          - get: ((release_branch))-version
            trigger: true
            passed:
              - ((release_branch))-build-warden-boshlite
              - ((release_branch))-build-aws-xen-hvm
              - ((release_branch))-build-azure-hyperv
              - ((release_branch))-build-google-kvm
              - ((release_branch))-build-openstack-kvm
              - ((release_branch))-build-vsphere-esxi
              - ((release_branch))-build-vcloud-esxi
          - get: ((release_branch))-bosh-linux-stemcell-builder
          - get: bosh-deployment
          - get: bosh-cli
          - get: syslog-release
          - get: os-conf-release
          - get: ((release_branch))-vsphere-esxi
            passed: [((release_branch))-build-vsphere-esxi]
            tags:
            - vsphere-v5.1
        - put: environment
          params:
            acquire: true

        - do:
          - task: deploy-director
            tags: [vsphere-v5.1]
            file: ((release_branch))-bosh-linux-stemcell-builder/ci/tasks/deploy-director.yml
            input_mapping:
              stemcell: ((release_branch))-vsphere-esxi
              bosh-linux-stemcell-builder: ((release_branch))-bosh-linux-stemcell-builder
              version: ((release_branch))-version
            params:
              BOSH_internal_ip:         ((stemcell-test-director-address))
              BOSH_internal_cidr:       ((bosh-director-vcenter-cidr))
              BOSH_internal_gw:         ((bosh-director-vcenter-gateway))
              BOSH_vcenter_ip:          ((vcenter-ip))
              BOSH_vcenter_user:        ((vcenter-user))
              BOSH_vcenter_password:    ((vcenter-password))
              BOSH_vcenter_dc:          ((vcenter-dc))
              BOSH_vcenter_cluster:     ((vcenter-cluster))
              BOSH_vcenter_ds:          ((vcenter-datastore))
              BOSH_network_name:        ((vcenter-vlan))
              BOSH_vcenter_vms:         ((vcenter-vm-folder))
              BOSH_vcenter_templates:   ((vcenter-template-folder))
              BOSH_vcenter_disks:       ((vcenter-disk-path))

          - task: test-stemcell
            tags: [vsphere-v5.1]
            file: ((release_branch))-bosh-linux-stemcell-builder/ci/tasks/test-stemcell.yml
            input_mapping:
              stemcell: ((release_branch))-vsphere-esxi
              bosh-linux-stemcell-builder: ((release_branch))-bosh-linux-stemcell-builder
              version: ((release_branch))-version
            params:
              BOSH_os_name: ((stemcell_os))-((stemcell_os_version))
              package: ipv4director
          ensure:
            task: teardown
            tags: [vsphere-v5.1]
            file: ((release_branch))-bosh-linux-stemcell-builder/ci/tasks/teardown.yml
        ensure:
          put: environment
          params:
            release: environment

- type: replace
  path: /jobs/-
  value:
    name: ((release_branch))-publish-stemcells
    serial: true
    plan:
      - aggregate:
        - get: ((release_branch))-version
          passed:
            - ((release_branch))-test-stemcells
            - ((release_branch))-bats
        - get: ((release_branch))-bosh-linux-stemcell-builder
          passed:
            - ((release_branch))-bats
        - get: stemcells-index
      - task: assert-version-aligns
        file: ((release_branch))-bosh-linux-stemcell-builder/ci/tasks/assert-version-aligns.yml
        params:
          VERSION_PREFIX: ((stemcell_version_prefix))
        input_mapping:
          bosh-linux-stemcell-builder: ((release_branch))-bosh-linux-stemcell-builder
          version: ((release_branch))-version
      - task: copy-artifacts
        file: ((release_branch))-bosh-linux-stemcell-builder/ci/tasks/publish.yml
        params:
          VERSION_PREFIX: ((stemcell_version_prefix))
          AWS_ACCESS_KEY_ID: ((stemcell_aws_access_key))
          AWS_SECRET_ACCESS_KEY: ((stemcell_aws_secret_key))
          CANDIDATE_BUCKET_NAME: ((candidate_stemcell_bucket))
          PUBLISHED_BUCKET_NAME: ((published_stemcell_bucket))
          OS_NAME: ((stemcell_os))
          OS_VERSION: ((stemcell_os_version))
          COPY_KEYS: |
            aws/bosh-stemcell-%s-aws-xen-hvm-((stemcell_os))-((stemcell_os_version)).tgz
            google/bosh-stemcell-%s-google-kvm-((stemcell_os))-((stemcell_os_version))-go_agent.tgz
            openstack/bosh-stemcell-%s-openstack-kvm-((stemcell_os))-((stemcell_os_version)).tgz
            warden/bosh-stemcell-%s-warden-boshlite-((stemcell_os))-((stemcell_os_version)).tgz
            vsphere/bosh-stemcell-%s-vsphere-esxi-((stemcell_os))-((stemcell_os_version)).tgz
            vcloud/bosh-stemcell-%s-vcloud-esxi-((stemcell_os))-((stemcell_os_version)).tgz
            azure/bosh-stemcell-%s-azure-hyperv-((stemcell_os))-((stemcell_os_version)).tgz
        input_mapping:
          bosh-linux-stemcell-builder: ((release_branch))-bosh-linux-stemcell-builder
          version: ((release_branch))-version
      - aggregate:
        - put: ((release_branch))-bosh-linux-stemcell-builder-push
          params:
            repository: ((release_branch))-bosh-linux-stemcell-builder
            tag: version-tag/tag
            only_tag: true
        - put: stemcells-index
          params:
            repository: stemcells-index
            rebase: true

  # WARDEN
  #

- type: replace
  path: /jobs/-
  value:
    name: ((release_branch))-build-warden-boshlite
    plan:
      - aggregate:
          - get: ((release_branch))-version
            trigger: true
            passed: [((release_branch))-build-stemcell]
          - get: ((release_branch))-bosh-linux-stemcell-builder
            passed: [((release_branch))-build-stemcell]
          - get: stemcells-index
      - task: create-stemcell
        file: ((release_branch))-bosh-linux-stemcell-builder/ci/tasks/build.yml
        privileged: true
        params:
          IAAS:         warden
          HYPERVISOR:   boshlite
          OS_NAME:      ((stemcell_os))
          OS_VERSION:   ((stemcell_os_version))
        input_mapping:
          bosh-linux-stemcell-builder: ((release_branch))-bosh-linux-stemcell-builder
          version: ((release_branch))-version
      - aggregate:
        - put: ((release_branch))-warden-boshlite
          params:
            file: stemcell/*.tgz
      - put: stemcells-index
        params:
          repository: stemcells-index
          rebase: true


  #
  # AWS
  #

- type: replace
  path: /jobs/-
  value:
    name: ((release_branch))-build-aws-xen-hvm
    plan:
      - aggregate:
          - get: ((release_branch))-version
            trigger: true
            passed: [((release_branch))-build-stemcell]
          - get: ((release_branch))-bosh-linux-stemcell-builder
            passed: [((release_branch))-build-stemcell]
          - get: stemcells-index
      - task: create-stemcell
        file: ((release_branch))-bosh-linux-stemcell-builder/ci/tasks/build.yml
        privileged: true
        params:
          IAAS:         aws
          HYPERVISOR:   xen-hvm
          OS_NAME:      ((stemcell_os))
          OS_VERSION:   ((stemcell_os_version))
        input_mapping:
          bosh-linux-stemcell-builder: ((release_branch))-bosh-linux-stemcell-builder
          version: ((release_branch))-version
      - aggregate:
        - put: ((release_branch))-aws-xen-hvm
          params:
            file: stemcell/*.tgz
      - put: stemcells-index
        params:
          repository: stemcells-index
          rebase: true


  #
  # Azure
  #

- type: replace
  path: /jobs/-
  value:
    name: ((release_branch))-build-azure-hyperv
    plan:
      - aggregate:
          - get: ((release_branch))-version
            trigger: true
            passed: [((release_branch))-build-stemcell]
          - get: ((release_branch))-bosh-linux-stemcell-builder
            passed: [((release_branch))-build-stemcell]
          - get: stemcells-index
      - task: create-stemcell
        file: ((release_branch))-bosh-linux-stemcell-builder/ci/tasks/build.yml
        privileged: true
        params:
          IAAS:         azure
          HYPERVISOR:   hyperv
          OS_NAME:      ((stemcell_os))
          OS_VERSION:   ((stemcell_os_version))
        input_mapping:
          bosh-linux-stemcell-builder: ((release_branch))-bosh-linux-stemcell-builder
          version: ((release_branch))-version
      - aggregate:
        - put: ((release_branch))-azure-hyperv
          params:
            file: stemcell/*.tgz
      - put: stemcells-index
        params:
          repository: stemcells-index
          rebase: true


  #
  # Google
  #

- type: replace
  path: /jobs/-
  value:
    name: ((release_branch))-build-google-kvm
    plan:
      - aggregate:
          - get: ((release_branch))-version
            trigger: true
            passed: [((release_branch))-build-stemcell]
          - get: ((release_branch))-bosh-linux-stemcell-builder
            passed: [((release_branch))-build-stemcell]
          - get: stemcells-index
      - task: create-stemcell
        file: ((release_branch))-bosh-linux-stemcell-builder/ci/tasks/build.yml
        privileged: true
        params:
          IAAS:         google
          HYPERVISOR:   kvm
          OS_NAME:      ((stemcell_os))
          OS_VERSION:   ((stemcell_os_version))
        input_mapping:
          bosh-linux-stemcell-builder: ((release_branch))-bosh-linux-stemcell-builder
          version: ((release_branch))-version
      - aggregate:
        - put: ((release_branch))-google-kvm
          params:
            file: stemcell/*-go_agent.tgz
      - put: stemcells-index
        params:
          repository: stemcells-index
          rebase: true


  #
  # OpenStack
  #

- type: replace
  path: /jobs/-
  value:
    name: ((release_branch))-build-openstack-kvm
    plan:
      - aggregate:
          - get: ((release_branch))-version
            trigger: true
            passed: [((release_branch))-build-stemcell]
          - get: ((release_branch))-bosh-linux-stemcell-builder
            passed: [((release_branch))-build-stemcell]
          - get: stemcells-index
      - task: create-stemcell
        file: ((release_branch))-bosh-linux-stemcell-builder/ci/tasks/build.yml
        privileged: true
        params:
          IAAS:         openstack
          HYPERVISOR:   kvm
          OS_NAME:      ((stemcell_os))
          OS_VERSION:   ((stemcell_os_version))
        input_mapping:
          bosh-linux-stemcell-builder: ((release_branch))-bosh-linux-stemcell-builder
          version: ((release_branch))-version
      - aggregate:
        - put: ((release_branch))-openstack-kvm-raw
          params:
            file: stemcell/*-raw.tgz
        - put: ((release_branch))-openstack-kvm
          params:
            file: stemcell/*-go_agent.tgz
      - put: stemcells-index
        params:
          repository: stemcells-index
          rebase: true


  #
  # vSphere
  #

- type: replace
  path: /jobs/-
  value:
    name: ((release_branch))-build-vsphere-esxi
    plan:
      - aggregate:
          - get: ((release_branch))-version
            trigger: true
            passed: [((release_branch))-build-stemcell]
          - get: ((release_branch))-bosh-linux-stemcell-builder
            passed: [((release_branch))-build-stemcell]
          - get: stemcells-index
      - task: create-stemcell
        file: ((release_branch))-bosh-linux-stemcell-builder/ci/tasks/build.yml
        privileged: true
        params:
          IAAS:         vsphere
          HYPERVISOR:   esxi
          OS_NAME:      ((stemcell_os))
          OS_VERSION:   ((stemcell_os_version))
        input_mapping:
          bosh-linux-stemcell-builder: ((release_branch))-bosh-linux-stemcell-builder
          version: ((release_branch))-version
      - aggregate:
        - put: ((release_branch))-vsphere-esxi
          params:
            file: stemcell/*.tgz
      - put: stemcells-index
        params:
          repository: stemcells-index
          rebase: true

  #
  # vCloud
  #

- type: replace
  path: /jobs/-
  value:
    name: ((release_branch))-build-vcloud-esxi
    plan:
      - aggregate:
          - get: ((release_branch))-version
            trigger: true
            passed: [((release_branch))-build-stemcell]
          - get: ((release_branch))-bosh-linux-stemcell-builder
            passed: [((release_branch))-build-stemcell]
          - get: stemcells-index
      - task: create-stemcell
        file: ((release_branch))-bosh-linux-stemcell-builder/ci/tasks/build.yml
        privileged: true
        params:
          IAAS:         vcloud
          HYPERVISOR:   esxi
          OS_NAME:      ((stemcell_os))
          OS_VERSION:   ((stemcell_os_version))
        input_mapping:
          bosh-linux-stemcell-builder: ((release_branch))-bosh-linux-stemcell-builder
          version: ((release_branch))-version
      - aggregate:
        - put: ((release_branch))-vcloud-esxi
          params:
            file: stemcell/*.tgz
      - put: stemcells-index
        params:
          repository: stemcells-index
          rebase: true

- type: replace
  path: /jobs/-
  value:
    name: ((release_branch))-bats
    serial: true
    plan:
    - do:
      - aggregate:
        - get: bosh-release
        - get: cpi-release
        - get: stemcell
          trigger: true
          tags:
          - vsphere-v5.1
          resource: ((release_branch))-vsphere-esxi
          passed:
            - ((release_branch))-build-vsphere-esxi
        - get: bosh-cli
        - get: bats
        - get: bosh-deployment
        - get: ((release_branch))-bosh-linux-stemcell-builder
          passed:
            - ((release_branch))-build-warden-boshlite
            - ((release_branch))-build-aws-xen-hvm
            - ((release_branch))-build-azure-hyperv
            - ((release_branch))-build-google-kvm
            - ((release_branch))-build-openstack-kvm
            - ((release_branch))-build-vsphere-esxi
            - ((release_branch))-build-vcloud-esxi
        - get: ((release_branch))-version
          passed:
            - ((release_branch))-build-warden-boshlite
            - ((release_branch))-build-aws-xen-hvm
            - ((release_branch))-build-azure-hyperv
            - ((release_branch))-build-google-kvm
            - ((release_branch))-build-openstack-kvm
            - ((release_branch))-build-vsphere-esxi
            - ((release_branch))-build-vcloud-esxi

      - {put: environment, params: {acquire: true}}

      - do:
        - task: deploy-director
          tags: [vsphere-v5.1]
          file: ((release_branch))-bosh-linux-stemcell-builder/ci/bats/tasks/deploy-director.yml
          params:
            BAT_INFRASTRUCTURE: vsphere
            BOSH_CLIENT:                          ((stemcell-test-director-username))
            BOSH_CLIENT_SECRET:                   ((stemcell-test-director-password))
            BOSH_VSPHERE_VCENTER:                 ((vcenter-ip))
            BOSH_VSPHERE_VCENTER_USER:            ((vcenter-user))
            BOSH_VSPHERE_VCENTER_PASSWORD:        ((vcenter-password))
            BOSH_VSPHERE_VERSION:                 ((vsphere-version))
            BOSH_VSPHERE_VCENTER_DC:              ((vcenter-dc))
            BOSH_VSPHERE_VCENTER_CLUSTER:         ((vcenter-cluster))
            BOSH_VSPHERE_VCENTER_DATASTORE:       ((vcenter-datastore))
            BOSH_VSPHERE_VCENTER_VLAN:            ((vcenter-vlan))
            BOSH_VSPHERE_VCENTER_VM_FOLDER:       ((vcenter-vm-folder))
            BOSH_VSPHERE_VCENTER_TEMPLATE_FOLDER: ((vcenter-template-folder))
            BOSH_VSPHERE_VCENTER_DISK_PATH:       ((vcenter-disk-path))
          input_mapping:
            bosh-linux-stemcell-builder: ((release_branch))-bosh-linux-stemcell-builder
            stemcell: ((release_branch))-vshpere-esxi

        - task: prepare-bats
          tags: [vsphere-v5.1]
          file: ((release_branch))-bosh-linux-stemcell-builder/ci/bats/iaas/vsphere/prepare-bats-config.yml
          params:
            STEMCELL_NAME: bosh-vsphere-esxi-((stemcell_os))-((stemcell_os_version))-go_agent
          input_mapping:
            bosh-linux-stemcell-builder: ((release_branch))-bosh-linux-stemcell-builder
            stemcell: ((release_branch))-vshpere-esxi

        - task: run-bats
          tags: [vsphere-v5.1]
          file: bats/ci/tasks/run-bats.yml
          input_mapping:
            stemcell: ((release_branch))-vshpere-esxi
        ensure:
          do:
            - task: teardown
              tags: [vsphere-v5.1]
              file: ((release_branch))-bosh-linux-stemcell-builder/ci/bats/tasks/destroy-director.yml
              input_mapping:
                bosh-linux-stemcell-builder: ((release_branch))-bosh-linux-stemcell-builder
      ensure:
        do:
        - {put: environment, params: {release: environment}}


- type: replace
  path: /resources/-
  value:
    name: ((release_branch))-os-image-tarball
    type: s3
    source:
      bucket: ((osimage_bucket))
      versioned_file: bosh-((stemcell_os))-((stemcell_os_version))-os-image.tgz
      access_key_id: ((osimage_aws_access_key))
      secret_access_key: ((osimage_aws_secret_key))

- type: replace
  path: /resources/-
  value:
    name: ((release_branch))-bosh-linux-stemcell-builder-push
    type: git
    source:
      uri: git@github.com:cloudfoundry/bosh-linux-stemcell-builder
      branch: ((release_branch))
      private_key: ((bosh_src_key))

- type: replace
  path: /resources/-
  value:
    name: ((release_branch))-bosh-linux-stemcell-builder
    type: git
    source:
      uri: https://github.com/cloudfoundry/bosh-linux-stemcell-builder
      branch: ((release_branch))

- type: replace
  path: /resources/-
  value:
    name: ((release_branch))-version
    type: semver
    source:
      driver: s3
      key: bosh-stemcell/version-((release_branch))
      bucket: ((candidate_stemcell_bucket))
      access_key_id: ((stemcell_aws_access_key))
      secret_access_key: ((stemcell_aws_secret_key))
      initial_version: ((initial_version))

  #
  # Stemcells
  #

  #
  # AWS
  #

- type: replace
  path: /resources/-
  value:
    name: ((release_branch))-aws-xen-hvm
    type: s3
    source:
      bucket: ((candidate_stemcell_bucket))
      regexp: aws/bosh-stemcell-(.+)-aws-xen-hvm-((stemcell_os))-((stemcell_os_version))-go_agent.tgz
      access_key_id: ((stemcell_aws_access_key))
      secret_access_key: ((stemcell_aws_secret_key))

  #
  # Azure
  #

- type: replace
  path: /resources/-
  value:
    name: ((release_branch))-azure-hyperv
    type: s3
    source:
      bucket: ((candidate_stemcell_bucket))
      regexp: azure/bosh-stemcell-(.+)-azure-hyperv-((stemcell_os))-((stemcell_os_version))-go_agent.tgz
      access_key_id: ((stemcell_aws_access_key))
      secret_access_key: ((stemcell_aws_secret_key))

  #
  # vSphere
  #

- type: replace
  path: /resources/-
  value:
    name: ((release_branch))-vsphere-esxi
    type: s3
    source:
      bucket: ((candidate_stemcell_bucket))
      regexp: vsphere/bosh-stemcell-(.+)-vsphere-esxi-((stemcell_os))-((stemcell_os_version))-go_agent.tgz
      access_key_id: ((stemcell_aws_access_key))
      secret_access_key: ((stemcell_aws_secret_key))

  #
  # Google
  #

- type: replace
  path: /resources/-
  value:
    name: ((release_branch))-google-kvm
    type: s3
    source:
      bucket: ((candidate_stemcell_bucket))
      regexp: google/bosh-stemcell-(.+)-google-kvm-((stemcell_os))-((stemcell_os_version))-go_agent.tgz
      access_key_id: ((stemcell_aws_access_key))
      secret_access_key: ((stemcell_aws_secret_key))

  #
  # Openstack
  #

- type: replace
  path: /resources/-
  value:
    name: ((release_branch))-openstack-kvm
    type: s3
    source:
      bucket: ((candidate_stemcell_bucket))
      regexp: openstack/bosh-stemcell-(.+)-openstack-kvm-((stemcell_os))-((stemcell_os_version))-go_agent.tgz
      access_key_id: ((stemcell_aws_access_key))
      secret_access_key: ((stemcell_aws_secret_key))

- type: replace
  path: /resources/-
  value:
    name: ((release_branch))-openstack-kvm-raw
    type: s3
    source:
      bucket: ((candidate_stemcell_bucket))
      regexp: openstack/bosh-stemcell-(.+)-openstack-kvm-((stemcell_os))-((stemcell_os_version))-go_agent-raw.tgz
      access_key_id: ((stemcell_aws_access_key))
      secret_access_key: ((stemcell_aws_secret_key))

  #
  # vCloud
  #

- type: replace
  path: /resources/-
  value:
    name: ((release_branch))-vcloud-esxi
    type: s3
    source:
      bucket: ((candidate_stemcell_bucket))
      regexp: vcloud/bosh-stemcell-(.+)-vcloud-esxi-((stemcell_os))-((stemcell_os_version))-go_agent.tgz
      access_key_id: ((stemcell_aws_access_key))
      secret_access_key: ((stemcell_aws_secret_key))

  #
  # Warden
  #

- type: replace
  path: /resources/-
  value:
    name: ((release_branch))-warden-boshlite
    type: s3
    source:
      bucket: ((candidate_stemcell_bucket))
      regexp: warden/bosh-stemcell-(.+)-warden-boshlite-((stemcell_os))-((stemcell_os_version))-go_agent.tgz
      access_key_id: ((stemcell_aws_access_key))
      secret_access_key: ((stemcell_aws_secret_key))
